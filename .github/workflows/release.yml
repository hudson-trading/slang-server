name: Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-version:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update VERSION file from release tag
      run: |
        TAG_NAME="${{ github.event.release.tag_name }}"
        VERSION="${TAG_NAME#v}"  # Strip 'v' prefix
        echo "$VERSION" > VERSION
        echo "Updated VERSION to: $VERSION"
        cat VERSION

    - name: Commit and push VERSION update to main
      run: |
        TAG_NAME="${{ github.event.release.tag_name }}"
        VERSION="${TAG_NAME#v}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add VERSION
        if git diff --staged --quiet; then
          echo "VERSION file already up to date"
        else
          git commit -m "$(cat <<EOF
        Update VERSION to $VERSION
        EOF
        )"
          git push origin main
        fi

  build:
    needs: update-version
    if: always()  # Run even if update-version is skipped (workflow_dispatch)
    uses: ./.github/workflows/build.yml
    with:
      upload_artifacts: true
      ref: main  # Build from main branch with updated VERSION

  add-release-assets:
    needs: build
    if: always() && github.event_name == 'release'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      id: prepare
      run: |
        mkdir -p release-assets
        if [ -d artifacts ]; then
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-assets/ \; 2>/dev/null || true
        fi
        if [ -z "$(ls -A release-assets 2>/dev/null)" ]; then
          echo "Warning: No release artifacts found"
          echo "has_artifacts=false" >> $GITHUB_OUTPUT
        else
          echo "has_artifacts=true" >> $GITHUB_OUTPUT
          ls -lh release-assets/
        fi

    - name: Get release info
      if: steps.prepare.outputs.has_artifacts == 'true'
      id: release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG_NAME="${{ github.event.release.tag_name }}"
        echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

        # Get existing release notes
        RELEASE_NOTES=$(gh release view "$TAG_NAME" --json body -q .body)
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Generate checksums and update release
      if: steps.prepare.outputs.has_artifacts == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG_NAME="${{ steps.release.outputs.tag }}"

        # Generate checksums
        cd release-assets
        CHECKSUMS=$(sha256sum * | sed 's/^/    /')
        cd ..

        # Append checksums to release notes
        cat > updated-notes.md << 'EOF'
        ${{ steps.release.outputs.notes }}

        ## Checksums

        ```
        EOF
        echo "$CHECKSUMS" >> updated-notes.md
        echo '```' >> updated-notes.md

        # Update release with checksums and upload artifacts
        gh release edit "$TAG_NAME" --notes-file updated-notes.md
        gh release upload "$TAG_NAME" release-assets/* --clobber
